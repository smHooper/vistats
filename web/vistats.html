<!DOCTYPE html>
<html>
<head>
	<meta charset='utf-8'>
	<meta name="viewport" content="width=device-width,height=device-height, user-scalable=no" />
	<title>Visitor Use Stats Portal</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css"/>
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
	
	<link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.css" rel="stylesheet">
	
	<link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
	<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

	<link rel="stylesheet" href="css/vistats.css">
</head>

<body>

	 <!-- loading indicator should be hidden and will only be shown when loading data -->
	<div id="loading-indicator-background" style="display: none;"></div>
	<div id="loading-indicator" style="display: none;"></div>

	<div style="display: flex; justify-content: center; width: 100%; height: 100%">
		
		<div id="main-container">
			
			<div id="header-menu">
				<div id="header-menu-content-container">
					<div class="header-menu-item" id="username-container">
						<img id="username-icon" src="imgs/user_icon_50px.svg">
						<span id="username"></span>
					</div> 
				</div> 
			</div>
		
			<form class="row mx-0 px-0 form-input-container" id="input-form">
				<div class=form-header>
					<div class='form-header-content-container'>
						<h5 class='form-header-title'>Visitor use stats for: </h5>
						<select id="month-select"></select>
					</div>
				</div>
				<table id='input-table'>
					<thead>
						<tr>
							<td></td>
							<td></td>
							<td>Estimated?</td>
							<td>Verified?</td>
							<td>Verified by</td>
						</tr>
					</thead>
					<tbody>
						<!--filled on load-->
					</tbody>
					<tfoot>
						<td></td>
						<td></td>
						<td></td>
						<td><button class="text-only-button table-footer-button hidden" id="verify-all-button" onclick="onVerifyAllClick(event)">verify all</button></td>
						<td></td>
					</tfoot>
				</table>
				<div class="form-footer">
					<button class="generic-button form-footer-button" id="save-button" onclick="onSaveClick(event)">save</button>
					<button class="generic-button form-footer-button" id="fill-stats-button" onclick="generateJavascript(event)">generate javascript</button>
				</div>		
			</form>
			<div id='js-text-container'>
				<p id='js-text'></p>
			</div>
		</div>
	
	</div>

	<script src="js/jquery.csv.min.js"></script>
	<script src="js/vistats.js"></script>

	<script type="text/javascript">
		
		$(document).ready(() => {

			showLoadingIndicator();
			$.when(
				queryDB(`SELECT id, count_date FROM count_periods`)
					.then((queryResultString)=> {$.parseJSON(queryResultString).forEach(
						(obj) => {COUNT_PERIODS[obj.id] = obj.count_date})}),
				$.ajax({
					url: 'vistats.php',
					method: 'POST',
					data: {action: 'getUser'},
					cache: false,
					success: function(usernameString){
						// If authentication failed, do nothing
						if (usernameString)  {
							username = usernameString.trim();
							$('#username').text(username);
							getUserRoles()
								.then(
									(jsonString) => {
									USER_ROLES = $.parseJSON(jsonString);
									configureForm();
								})
						} else {
							$('#username-icon').addClass('hidden')
							alert(`Your username could not be retreived so you won't be able to make any edits`)
							$('#input-form').addClass('hidden')
						}
					}
				}),
				fillSelectOptions('month-select', `SELECT count_date AS value, to_char(count_date, 'FMMonth, YYYY') AS name FROM count_periods ORDER BY count_date DESC;`, 'month-select-option')
			)
			.then(function() {
				hideLoadingIndicator();
				$('#month-select').change(function() {onMonthSelectChange()});
			});


		})

	</script>
</body>


</html>